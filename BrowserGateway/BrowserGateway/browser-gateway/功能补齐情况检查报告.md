# BrowserGatewayåŠŸèƒ½ç¼ºå¤±è¡¥å……è®¡åˆ’æŠ¥å‘Š

## ä¸€ã€åŠŸèƒ½ç¼ºå¤±æ±‡æ€»

æœ¬æŠ¥å‘Šåˆ†æå­˜é‡ä»£ç ä¸­åœ¨é‡å†™ä»£ç ä¸­ç¼ºå¤±çš„ä¸¤ä¸ªå…³é”®åŠŸèƒ½ï¼š

1. **JSæ‰©å±•åŠ è½½åŠŸèƒ½** (JS Extension Loading)
2. **æµè§ˆå™¨è‡ªåŠ¨æ£€æŸ¥ä»»åŠ¡** (BrowserCheckTask)

## äºŒã€JSæ‰©å±•åŠ è½½åŠŸèƒ½åˆ†æ

### 2.1 å­˜é‡ä»£ç å®ç°æ–¹æ¡ˆ

#### 2.1.1 æ ¸å¿ƒå®ç°ç±»ï¼š`PluginManageImpl.loadJSExtension()`

```java
/**
 * åŠ è½½JavaScriptæ‰©å±•æ–‡ä»¶
 * @param keyPath æŒ‰é”®æ‰©å±•æ–‡ä»¶è·¯å¾„
 * @param touchPath è§¦æ§æ‰©å±•æ–‡ä»¶è·¯å¾„
 * @return æ˜¯å¦æˆåŠŸ
 */
public boolean loadJSExtension(String keyPath, String touchPath) {
    // å¤„ç†æŒ‰é”®æ‰©å±•
    if (!StringUtil.isBlank(keyPath)) {
        FileUtil.del(config.getKeyExtensionPath());  // åˆ é™¤æ—§æ‰©å±•
        FileUtil.copy(keyPath, FileUtil.getParent(config.getKeyExtensionPath(), 1), true);  // å¤åˆ¶æ–°æ‰©å±•
    }
    
    // å¤„ç†è§¦æ§æ‰©å±•
    if (!StringUtil.isBlank(touchPath)) {
        FileUtil.del(config.getTouchExtensionPath());  // åˆ é™¤æ—§æ‰©å±•
        FileUtil.copy(touchPath, FileUtil.getParent(config.getTouchExtensionPath(), 1), true);  // å¤åˆ¶æ–°æ‰©å±•
    }
    
    return true;
}
```

#### 2.1.2 é…ç½®ç»“æ„ï¼šæ‰©å±•è·¯å¾„ç®¡ç†

**Configç±»ä¸­çš„æ‰©å±•è·¯å¾„æ–¹æ³•ï¼š**
```java
// æ‰©å±•è·¯å¾„å¸¸é‡
public static final String EXTENSION_PATH = "extension";
public static final String KEY = "keys";
public static final String TOUCH = "touch";
public static final String RECORD = "record";
public static final String JAR = "jar";

// è·å–å„ç±»æ‰©å±•è·¯å¾„
public String getKeyExtensionPath() {
    return workspace + File.separator + EXTENSION_PATH + File.separator + KEY + File.separator + "chrome";
}

public String getTouchExtensionPath() {
    return workspace + File.separator + EXTENSION_PATH + File.separator + TOUCĞ¹ + File.separator + "chrome";
}

public String getRecordExtensionPath() {
    return workspace + File.separator + EXTENSION_PATH + File.separator + RECORD + File.separator + "chrome";
}

public String getJarDirPath() {
    return workspace + File.separator + JAR;
}
```

#### 2.1.3 æ•´åˆåŠ è½½æµç¨‹

åœ¨`loadPlugin()`æ–¹æ³•ä¸­ç»Ÿä¸€å¤„ç†JSæ‰©å±•å’ŒSDKåŠ è½½ï¼š
```java
@Override
public void loadPlugin(String keyPath, String touchPath, String jarPath) {
    // å…ˆåŠ è½½SDKï¼Œå†åŠ è½½JSæ‰©å±•
    boolean success = loadSDK(jarPath) && loadJSExtension(keyPath, touchPath);
    
    // æ ¹æ®æˆåŠŸä¸å¦æ›´æ–°çŠ¶æ€å¹¶å‘é€å‘Šè­¦
    if (success) {
        updateStatus(Constant.COMPLETE);
    } else {
        updateStatus(Constant.FAILED);
    }
}
```

#### 2.1.4 æ‰©å±•ç›®å½•ç»“æ„

```
/workspace/
â”œâ”€â”€ extension/
â”‚   â”œâ”€â”€ keys/chrome/           # æŒ‰é”®æ‰©å±•ç›®å½•
â”‚   â”‚   â””â”€â”€ [æŒ‰é”®æ‰©å±•æ–‡ä»¶]
â”‚   â”œâ”€â”€ touch/chrome/          # è§¦æ§æ‰©å±•ç›®å½•
â”‚   â”‚   â””â”€â”€ [è§¦æ§æ‰©å±•æ–‡ä»¶]
â”‚   â””â”€â”€ record/chrome/         # è®°å½•æ‰©å±•ç›®å½•
â”‚       â””â”€â”€ [è®°å½•æ‰©å±•æ–‡ä»¶]
â””â”€â”€ jar/                       # SDK JARç›®å½•
    â””â”€â”€ [SDK JARæ–‡ä»¶]
```

### 2.2 ä½¿ç”¨åœºæ™¯åˆ†æ

#### 2.2.1 æ‰©å±•ç±»å‹

| æ‰©å±•ç±»å‹ | åŠŸèƒ½è¯´æ˜ | æ–‡ä»¶æ¥æº | å­˜å‚¨ä½ç½® |
|---------|---------|---------|---------|
| Keysæ‰©å±• | é”®ç›˜è¾“å…¥å¤„ç† | keyPathå‚æ•° | extension/keys/chrome/ |
| Touchæ‰©å±• | è§¦å±äº‹ä»¶å¤„ç† | touchPathå‚æ•° | extension/touch/chrome/ |
| Recordæ‰©å±• | å½•åˆ¶åŠŸèƒ½ | configå›ºå®šé…ç½® | extension/record/chrome/ |

#### 2.2.2 è°ƒç”¨é“¾è·¯

```
å®¢æˆ·ç«¯è¯·æ±‚ -> ExtensionManageAPI -> ExtensionManageService -> PluginManage.loadJSExtension()
```

#### 2.2.3 ç”Ÿå‘½å‘¨æœŸç®¡ç†

1. **åŠ è½½é˜¶æ®µ**ï¼š`loadPlugin()`åŒæ—¶å¤„ç†SDKå’ŒJSæ‰©å±•çš„åŠ è½½
2. **éªŒè¯é˜¶æ®µ**ï¼š`loadJSExtension()`éªŒè¯æ–‡ä»¶å­˜åœ¨æ€§å¹¶å¤åˆ¶ç›®æ ‡ä½ç½®
3. **æ¸…ç†é˜¶æ®µ**ï¼šåŠ è½½å‰å…ˆåˆ é™¤æ—§çš„æ‰©å±•æ–‡ä»¶ï¼Œç¡®ä¿é‡æ–°åŠ è½½

### 2.3 é‡å†™ä»£ç ç¼ºå¤±çš„å…³é”®ç‚¹

1. **loadJSExtension()æ–¹æ³•å®Œå…¨ç¼ºå¤±**
2. **Configç±»çš„æ‰©å±•è·¯å¾„æ–¹æ³•ç¼ºå¤±**
3. **æ‰©å±•è·¯å¾„é…ç½®ç¼ºå¤±**
4. **JSæ‰©å±•ä¸SDKåŠ è½½çš„æ•´åˆé€»è¾‘ç¼ºå¤±**

## ä¸‰ã€BrowserCheckTaskåŠŸèƒ½åˆ†æ

### 3.1 å­˜é‡ä»£ç å®ç°æ–¹æ¡ˆ

#### 3.1.1 æ ¸å¿ƒå®ç°ç±»ï¼š`BrowserCheckTask`

```java
@Component
public class BrowserCheckTask {
    private static final Logger log = LogManager.getLogger(BrowserCheckTask.class);
    
    @Autowired
    private IChromeSet chromeSet;
    
    @Autowired
    private Config config;
    
    @Value("${browsergw.scheduled.check-browser-period:1800000}")
    private long period;  // é»˜è®¤30åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    
    private ScheduledExecutorService scheduler;
    private DriverClient client;

    @PostConstruct
    public void init() {
        // åˆå§‹åŒ–Chromeå¥åº·æ£€æŸ¥å®¢æˆ·ç«¯
        client = new ClientImpl(config.getChrome().getEndpoint());
        // å¯åŠ¨å®šæ—¶ä»»åŠ¡
        scheduler = Executors.newSingleThreadScheduledExecutor();
        scheduler.scheduleAtFixedRate(this::checkBrowsers, 0, period, TimeUnit.MILLISECONDS);
    }

    public void checkBrowsers() {
        try {
            log.info("begin scheduled task for check browsers status.");
            long start = System.currentTimeMillis();
            
            // 1. æ‰§è¡ŒChromeå¥åº·æ£€æŸ¥
            Type.HealthCheckResult result = client.browser().healthCheck();
            if (result.isSuccess()) {
                log.info("check browsers success. cost:{}ms", System.currentTimeMillis() - start);
                return;  // å¥åº·æ£€æŸ¥æˆåŠŸï¼Œæ— éœ€å¤„ç†
            }

            // 2. è·å–æ‰€æœ‰ç”¨æˆ·å®ä¾‹
            Set<String> users = chromeSet.getAllUser();

            // 3. æ‰¾å‡ºå¼‚å¸¸çš„æµè§ˆå™¨å®ä¾‹
            Set<String> delUsers = new HashSet<>();
            for (String user : users) {
                UserChrome userChrome = chromeSet.get(user);
                String proxyContextId = userChrome.getChromeDriver().getProxyContextId();
                
                // æ£€æŸ¥ä¸Šä¸‹æ–‡IDæ˜¯å¦åœ¨é”™è¯¯åˆ—è¡¨ä¸­
                if (result.getErrContexts().contains(proxyContextId)) {
                    delUsers.add(user);
                }
            }
            
            // 4. åˆ é™¤å¼‚å¸¸å®ä¾‹
            log.info("These user instances have expired:{}, close.", JSONUtil.toJsonStr(delUsers));
            delUsers.forEach(chromeSet::delete);
            
            log.info("end scheduled task for check browsers status. cost:{}ms"
                    , System.currentTimeMillis() - start);
        } catch (Exception e) {
            log.error("check browser task error.", e);
        }
    }

    @PreDestroy
    public void destroy() {
        // æ¸…ç†èµ„æº
        if (scheduler != null) {
            scheduler.shutdown();
        }
    }
}
```

#### 3.1.2 å…³é”®ä¾èµ–ç»„ä»¶

1. **DriverClient**: Chromeé©±åŠ¨çš„å¥åº·æ£€æŸ¥å®¢æˆ·ç«¯
   - `new ClientImpl(config.getChrome().getEndpoint())`
   - æä¾›`browser().healthCheck()`æ–¹æ³•

2. **IChromeSet**: æµè§ˆå™¨å®ä¾‹ç®¡ç†æ¥å£
   - `getAllUser()`: è·å–æ‰€æœ‰æ´»è·ƒç”¨æˆ·
   - `get(String userId)`: è·å–æŒ‡å®šç”¨æˆ·çš„æµè§ˆå™¨å®ä¾‹

3. **UserChrome**: ç”¨æˆ·æµè§ˆå™¨å®ä¾‹
   - `getChromeDriver()`: è·å–Chromeé©±åŠ¨
   - `getProxyContextId()`: è·å–ä»£ç†ä¸Šä¸‹æ–‡ID

4. **å¥åº·æ£€æŸ¥ç»“æœ**
   - `HealthCheckResult.isSuccess()`: æ£€æŸ¥æ˜¯å¦æˆåŠŸ
   - `HealthCheckResult.getErrContexts()`: è·å–é”™è¯¯ä¸Šä¸‹æ–‡åˆ—è¡¨

#### 3.1.3 æ‰§è¡Œç­–ç•¥

- **æ‰§è¡Œé¢‘ç‡**: é»˜è®¤30åˆ†é’Ÿä¸€æ¬¡ï¼ˆå¯é…ç½®`browsergw.scheduled.check-browser-period`ï¼‰
- **æ‰§è¡Œæ–¹å¼**: å•çº¿ç¨‹å®šæ—¶è°ƒåº¦
- **èµ„æºç®¡ç†**: ä½¿ç”¨`@PreDestroy`ç¡®ä¿çº¿ç¨‹æ± æ­£ç¡®å…³é—­
- **é”™è¯¯å¤„ç†**: æ•è·æ‰€æœ‰å¼‚å¸¸ï¼Œé˜»æ­¢ä»»åŠ¡ä¸­æ–­

### 3.2 åŠŸèƒ½ä»·å€¼

1. **è‡ªåŠ¨æ•…éšœæ¢å¤**: è‡ªåŠ¨å‘ç°å¹¶å…³é—­å¼‚å¸¸çš„æµè§ˆå™¨å®ä¾‹
2. **èµ„æºä¼˜åŒ–**: é¿å…æ— æ•ˆçš„æµè§ˆå™¨è¿›ç¨‹å ç”¨èµ„æº
3. **ç”¨æˆ·ä½“éªŒ**: ç¡®ä¿ç”¨æˆ·æµè§ˆå™¨å®ä¾‹å§‹ç»ˆå¤„äºå¥åº·çŠ¶æ€
4. **ç³»ç»Ÿç¨³å®šæ€§**: å®šæœŸæ¸…ç†ï¼Œé˜²æ­¢ç³»ç»Ÿèµ„æºæ³„æ¼

### 3.3 é‡å†™ä»£ç ç¼ºå¤±çš„å…³é”®ç‚¹

1. **BrowserCheckTaskç±»å®Œå…¨ç¼ºå¤±**
2. **Chromeå¥åº·æ£€æŸ¥å®¢æˆ·ç«¯(DriverClient)ç¼ºå¤±**
3. **é”™è¯¯ä¸Šä¸‹æ–‡æ£€æŸ¥é€»è¾‘ç¼ºå¤±**

## å››ã€é‡å†™ä»£ç ä¸­è¡¥å……æ–¹æ¡ˆ

### 4.1 JSæ‰©å±•åŠ è½½åŠŸèƒ½è¡¥å……æ–¹æ¡ˆ

#### 4.1.1 æ‰©å±•é…ç½®ç±»

æ–°å»º`ExtensionConfig`ç±»ï¼š
```java
@Component
@ConfigurationProperties(prefix = "browsergw.extensions")
public class ExtensionConfig {
    
    @Value("${browsergw.workspace:/opt/host}")
    private String workspace;
    
    public String getKeyExtensionPath() {
        return workspace + File.separator + "extension" + File.separator + "keys" + File.separator + "chrome";
    }
    
    public String getTouchExtensionPath() {
        return workspace + File.separator + "extension" + File.separator + "touch" + File.separator + "chrome";
    }
    
    public String getRecordExtensionPath() {
        return workspace + File.separator + "extension" + File.separator + "record" + File.separator + "chrome";
    }
    
    public String getJarDirPath() {
        return workspace + File.separator + "jar";
    }
}
```

#### 4.1.2 æ‰©å±•åŠ è½½æœåŠ¡æ–¹æ³•

åœ¨`PluginManageImpl`ä¸­è¡¥å……ï¼š
```java
/**
 * åŠ è½½JavaScriptæ‰©å±•æ–‡ä»¶
 * @param keyPath æŒ‰é”®æ‰©å±•æ–‡ä»¶è·¯å¾„
 * @param touchPath è§¦æ§æ‰©å±•æ–‡ä»¶è·¯å¾„
 * @return æ˜¯å¦æˆåŠŸ
 * @throws FileStorageException æ–‡ä»¶æ“ä½œå¼‚å¸¸
 */
public boolean loadJSExtension(String keyPath, String touchPath) throws FileStorageException {
    try {
        // å¤„ç†æŒ‰é”®æ‰©å±•
        if (!StringUtils.isBlank(keyPath)) {
            Path keyTarget = Paths.get(extensionConfig.getKeyExtensionPath());
            // åˆ é™¤æ—§æ‰©å±•
            if (Files.exists(keyTarget)) {
                Files.deleteIfExists(keyTarget);
            }
            // ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
            Files.createDirectories(keyTarget.getParent());
            // å¤åˆ¶æ–°æ‰©å±•
            Files.copy(Paths.get(keyPath), keyTarget, StandardCopyOption.REPLACE_EXISTING);
            log.info("æŒ‰é”®æ‰©å±•åŠ è½½æˆåŠŸ: {}", keyPath);
        }
        
        // å¤„ç†è§¦æ§æ‰©å±•
        if (!StringUtils.isBlank(touchPath)) {
            Path touchTarget = Paths.get(extensionConfig.getTouchExtensionPath());
            // åˆ é™¤æ—§æ‰©å±•
            if (Files.exists(touchTarget)) {
                Files.deleteIfExists(touchTarget);
            }
            // ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
            Files.createDirectories(touchTarget.getParent());
            // å¤åˆ¶æ–°æ‰©å±•
            Files.copy(Paths.get(touchPath), touchTarget, StandardCopyOption.REPLACE_EXISTING);
            log.info("è§¦æ§æ‰©å±•åŠ è½½æˆåŠŸ: {}", touchPath);
        }
        
        return true;
    } catch (IOException e) {
        log.error("åŠ è½½JSæ‰©å±•å¤±è´¥: keyPath={}, touchPath={}", keyPath, touchPath, e);
        throw new FileStorageException("åŠ è½½JSæ‰©å±•å¤±è´¥", e);
    }
}

/**
 * æ›´æ–°loadPluginæ–¹æ³•ï¼Œæ•´åˆJSæ‰©å±•åŠ è½½
 */
@Override
public boolean loadExtension(LoadExtensionRequest request) {
    try {
        // 1. éªŒè¯è¯·æ±‚
        validateRequest(request);
        
        // 2. ä¸‹è½½æ’ä»¶JARæ–‡ä»¶
        String localJarPath = downloadPluginJar(request);
        
        // 3. åŠ è½½SDK
        if (localJarPath != null) {
            Path jarPath = Paths.get(localJarPath);
            muenPluginClassLoader = new MuenPluginClassLoader();
            boolean sdkSuccess = muenPluginClassLoader.init(jarPath);
            if (!sdkSuccess) {
                log.error("SDKåŠ è½½å¤±è´¥");
                return false;
            }
        }
        
        // 4. åŠ è½½JSæ‰©å±•ï¼ˆæ–°å¢è¿™ä¸€æ­¥ï¼‰
        boolean extensionSuccess = loadJSExtension(request.getKeyPath(), request.getTouchPath());
        
        // 5. æ›´æ–°æ’ä»¶çŠ¶æ€
        updatePluginActive(request.getName(), request.getVersion(), request.getType());
        if (localJarPath != null && extensionSuccess) {
            updateStatus("COMPLETE");
        } else {
            updateStatus("FAILED");
        }
        
        return localJarPath != null && extensionSuccess;
    } catch (Exception e) {
        log.error("åŠ è½½æ’ä»¶å¤±è´¥: {}", request.getName(), e);
        sendPluginLoadFailureAlarm(request.getName(), request.getVersion(), e.getMessage());
        updateStatus("FAILED");
        return false;
    }
}
```

#### 4.1.3 æ‰©å±•è¯·æ±‚å¯¹è±¡æ›´æ–°

æ›´æ–°`LoadExtensionRequest`ç±»ï¼Œæ·»åŠ æ‰©å±•è·¯å¾„å­—æ®µï¼š
```java
public class LoadExtensionRequest {
    // ... ç°æœ‰å­—æ®µ
    
    /**
     * æŒ‰é”®æ‰©å±•æ–‡ä»¶è·¯å¾„
     */
    private String keyPath;
    
    /**
     * è§¦æ§æ‰©å±•æ–‡ä»¶è·¯å¾„
     */
    private String touchPath;
    
    // getter/setteræ–¹æ³•
}
```

#### 4.1.4 é…ç½®æ–‡ä»¶æ›´æ–°

åœ¨`application.yaml`ä¸­æ·»åŠ æ‰©å±•é…ç½®ï¼š
```yaml
browsergw:
  extensions:
    # æ‰©å±•åŸºæœ¬è·¯å¾„é…ç½®
    workspace: /opt/host
```

### 4.2 BrowserCheckTaskåŠŸèƒ½è¡¥å……æ–¹æ¡ˆ

#### 4.2.1 å¥åº·æ£€æŸ¥ä»»åŠ¡ç±»

æ–°å»º`BrowserCheckTask`ç±»ï¼š
```java
@Component
public class BrowserCheckTask {
    private static final Logger log = LoggerFactory.getLogger(BrowserCheckTask.class);
    
    @Autowired
    private IChromeSet chromeSet;
    
    @Autowired
    private Config config;
    
    @Value("${browsergw.scheduled.check-browser-period:1800000}")
    private long period;
    
    private ScheduledExecutorService scheduler;
    
    @PostConstruct
    public void init() {
        scheduler = Executors.newSingleThreadScheduledExecutor();
        scheduler.scheduleAtFixedRate(this::checkBrowsers, 0, period, TimeUnit.MILLISECONDS);
        log.info("æµè§ˆå™¨å¥åº·æ£€æŸ¥ä»»åŠ¡å·²å¯åŠ¨ï¼Œæ£€æŸ¥é—´éš”: {}ms", period);
    }
    
    @Scheduled(fixedRateString = "${browsergw.scheduled.check-browser-period:1800000}")
    public void checkBrowsers() {
        try {
            log.info("å¼€å§‹æ‰§è¡Œæµè§ˆå™¨å¥åº·æ£€æŸ¥ä»»åŠ¡");
            long start = System.currentTimeMillis();
            
            // 1. æ‰§è¡ŒChromeå¥åº·æ£€æŸ¥
            Type.HealthCheckResult result = performHealthCheck();
            if (result.isSuccess()) {
                log.info("æµè§ˆå™¨å¥åº·æ£€æŸ¥æˆåŠŸï¼Œè€—æ—¶: {}ms", System.currentTimeMillis() - start);
                return;
            }
            
            // 2. è·å–æ‰€æœ‰ç”¨æˆ·å®ä¾‹å¹¶æ£€æŸ¥å¼‚å¸¸
            Set<String> abnormalUsers = findAbnormalUsers(result);
            
            // 3. æ¸…ç†å¼‚å¸¸å®ä¾‹
            cleanupAbnormalInstances(abnormalUsers);
            
            log.info("æµè§ˆå™¨å¥åº·æ£€æŸ¥å®Œæˆï¼Œè€—æ—¶: {}ms", System.currentTimeMillis() - start);
        } catch (Exception e) {
            log.error("æµè§ˆå™¨å¥åº·æ£€æŸ¥ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸", e);
        }
    }
    
    /**
     * æ‰§è¡ŒChromeå¥åº·æ£€æŸ¥
     */
    private Type.HealthCheckResult performHealthCheck() {
        try {
            // æ¨¡æ‹ŸåŸæœ‰å®ç°ä¸­çš„å¥åº·æ£€æŸ¥è°ƒç”¨
            // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„Chromeé©±åŠ¨APIè¿›è¡Œè°ƒæ•´
            String chromeEndpoint = config.getChrome().getEndpoint();
            HealthCheckClient healthClient = new HealthCheckClient(chromeEndpoint);
            return healthClient.healthCheck();
        } catch (Exception e) {
            log.error("æ‰§è¡ŒChromeå¥åº·æ£€æŸ¥å¤±è´¥", e);
            // è¿”å›å¤±è´¥ç»“æœï¼Œè§¦å‘åç»­æ¸…ç†é€»è¾‘
            return createFailedHealthCheckResult();
        }
    }
    
    /**
     * æŸ¥æ‰¾å¼‚å¸¸ç”¨æˆ·å®ä¾‹
     */
    private Set<String> findAbnormalUsers(Type.HealthCheckResult result) {
        Set<String> abnormalUsers = new HashSet<>();
        Set<String> allUsers = chromeSet.getAllUser();
        
        for (String userId : allUsers) {
            try {
                UserChrome userChrome = chromeSet.get(userId);
                if (userChrome != null && userChrome.getChromeDriver() != null) {
                    String proxyContextId = userChrome.getChromeDriver().getProxyContextId();
                    if (result.getErrContexts() != null && result.getErrContexts().contains(proxyContextId)) {
                        abnormalUsers.add(userId);
                    }
                }
            } catch (Exception e) {
                log.warn("æ£€æŸ¥ç”¨æˆ·å®ä¾‹å¤±è´¥: userId={}", userId, e);
                // å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œå°†ç”¨æˆ·æ ‡è®°ä¸ºå¼‚å¸¸
                abnormalUsers.add(userId);
            }
        }
        
        return abnormalUsers;
    }
    
    /**
     * æ¸…ç†å¼‚å¸¸å®ä¾‹
     */
    private void cleanupAbnormalInstances(Set<String> abnormalUsers) {
        if (abnormalUsers.isEmpty()) {
            return;
        }
        
        log.info("å‘ç°å¼‚å¸¸ç”¨æˆ·å®ä¾‹ï¼Œå‡†å¤‡æ¸…ç†: {}", JSONUtil.toJsonStr(abnormalUsers));
        
        Set<String> successfulCleanup = new HashSet<>();
        Set<String> failedCleanup = new HashSet<>();
        
        for (String userId : abnormalUsers) {
            try {
                chromeSet.delete(userId);
                successfulCleanup.add(userId);
                log.info("æˆåŠŸæ¸…ç†å¼‚å¸¸ç”¨æˆ·å®ä¾‹: userId={}", userId);
            } catch (Exception e) {
                failedCleanup.add(userId);
                log.error("æ¸…ç†å¼‚å¸¸ç”¨æˆ·å®ä¾‹å¤±è´¥: userId={}", userId, e);
            }
        }
        
        // å‘é€ç›¸å…³å‘Šè­¦
        if (!failedCleanup.isEmpty()) {
            sendCleanupFailureAlarm(abnormalUsers, successfulCleanup, failedCleanup);
        }
    }
    
    /**
     * å‘é€æ¸…ç†å¤±è´¥å‘Šè­¦
     */
    private void sendCleanupFailureAlarm(Set<String> abnormalUsers, Set<String> successful, Set<String> failed) {
        try {
            if (adapterFactory != null) {
                AlarmAdapter alarmAdapter = adapterFactory.createAlarmAdapter();
                if (alarmAdapter != null) {
                    Map<String, String> parameters = new HashMap<>();
                    parameters.put("abnormalUsers", JSONUtil.toJsonStr(abnormalUsers));
                    parameters.put("successfulCount", String.valueOf(successful.size()));
                    parameters.put("failedCount", String.valueOf(failed.size()));
                    
                    alarmAdapter.sendAlarm("browser-cleanup-failure", 
                                         AlarmAdapter.AlarmType.WARNING, 
                                         parameters);
                }
            }
        } catch (Exception e) {
            log.error("å‘é€æµè§ˆå™¨æ¸…ç†å¤±è´¥å‘Šè­¦å¤±è´¥", e);
        }
    }
    
    @PreDestroy
    public void destroy() {
        if (scheduler != null) {
            scheduler.shutdown();
            try {
                if (!scheduler.awaitTermination(5, TimeUnit.SECONDS)) {
                    scheduler.shutdownNow();
                }
            } catch (InterruptedException e) {
                scheduler.shutdownNow();
                Thread.currentThread().interrupt();
            }
            log.info("æµè§ˆå™¨å¥åº·æ£€æŸ¥ä»»åŠ¡å·²åœæ­¢");
        }
    }
    
    // è¾…åŠ©æ–¹æ³•
    private Type.HealthCheckResult createFailedHealthCheckResult() {
        Type.HealthCheckResult result = new Type.HealthCheckResult();
        result.setSuccess(false);
        result.setErrContexts(new HashSet<>()); // è¿”å›ç©ºé”™è¯¯ä¸Šä¸‹æ–‡åˆ—è¡¨
        return result;
    }
}
```

#### 4.2.2 å¥åº·æ£€æŸ¥å®¢æˆ·ç«¯æ¥å£

æ–°å»º`HealthCheckClient`ç±»ï¼š
```java
/**
 * Chromeå¥åº·æ£€æŸ¥å®¢æˆ·ç«¯
 */
public class HealthCheckClient {
    private static final Logger log = LoggerFactory.getLogger(HealthCheckClient.class);
    
    private final String endpoint;
    
    public HealthCheckClient(String endpoint) {
        this.endpoint = endpoint;
        if (StringUtils.isBlank(endpoint)) {
            log.warn("Chromeå¥åº·æ£€æŸ¥ç«¯ç‚¹ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤ç«¯ç‚¹");
            this.endpoint = "http://localhost:9515";  // Chromeè°ƒè¯•ç«¯å£
        }
    }
    
    /**
     * æ‰§è¡Œå¥åº·æ£€æŸ¥
     */
    public Type.HealthCheckResult healthCheck() {
        try {
            // åˆ›å»ºHTTPå®¢æˆ·ç«¯
            CloseableHttpClient httpClient = HttpClients.createDefault();
            
            // æ„å»ºå¥åº·æ£€æŸ¥è¯·æ±‚
            HttpGet request = new HttpGet(endpoint + "/json/version");
            
            // æ‰§è¡Œè¯·æ±‚
            try (CloseableHttpResponse response = httpClient.execute(request)) {
                int statusCode = response.getStatusLine().getStatusCode();
                
                if (statusCode == 200) {
                    // è§£æå“åº”
                    String json = EntityUtils.toString(response.getEntity());
                    JSONObject jsonObject = JSON.parseObject(json);
                    
                    Type.HealthCheckResult result = new Type.HealthCheckResult();
                    result.setSuccess(true);
                    result.setBrowserVersion(jsonObject.getString("Browser"));
                    result.setRevision(jsonObject.getString("Revision"));
                    
                    log.debug("Chromeå¥åº·æ£€æŸ¥æˆåŠŸ: {}", jsonObject.toJSONString());
                    return result;
                } else {
                    log.warn("Chromeå¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒçŠ¶æ€ç : {}", statusCode);
                    return createFailedHealthCheckResult();
                }
            }
        } catch (Exception e) {
            log.error("æ‰§è¡ŒChromeå¥åº·æ£€æŸ¥å¼‚å¸¸", e);
            return createFailedHealthCheckResult();
        }
    }
    
    /**
     * åˆ›å»ºå¤±è´¥çš„å¥åº·æ£€æŸ¥ç»“æœ
     */
    private Type.HealthCheckResult createFailedHealthCheckResult() {
        Type.HealthCheckResult result = new Type.HealthCheckResult();
        result.setSuccess(false);
        log.debug("Chromeå¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè¿”å›å¤±è´¥ç»“æœ");
        return result;
    }
}
```

#### 4.2.3 å¥åº·æ£€æŸ¥ç»“æœç±»

æ–°å»º`HealthCheckResult`ç±»ï¼ˆå¦‚ä¸å­˜åœ¨ï¼‰ï¼š
```java
/**
 * Chromeå¥åº·æ£€æŸ¥ç»“æœ
 */
public class HealthCheckResult {
    private boolean success;
    private String browserVersion;
    private String revision;
    private Set<String> errContexts;
    
    // getter/setteræ–¹æ³•
    public boolean isSuccess() {
        return success;
    }
    
    public void setSuccess(boolean success) {
        this.success = success;
    }
    
    public String getBrowserVersion() {
        return browserVersion;
    }
    
    public void setBrowserVersion(String browserVersion) {
        this.browserVersion = browserVersion;
    }
    
    public String getRevision() {
        return revision;
    }
    
    public void setRevision(String revision) {
        this.revision = revision;
    }
    
    public Set<String> getErrContexts() {
        return errContexts;
    }
    
    public void setErrContexts(Set<String> errContexts) {
        this.errContexts = errContexts;
    }
}
```

#### 4.2.4 é…ç½®æ–‡ä»¶æ›´æ–°

åœ¨`application.yaml`ä¸­æ·»åŠ å¥åº·æ£€æŸ¥é…ç½®ï¼š
```yaml
browsergw:
  scheduled:
    # æµè§ˆå™¨å¥åº·æ£€æŸ¥é—´éš”ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤30åˆ†é’Ÿ
    check-browser-period: 1800000
  chrome:
    # Chromeè°ƒè¯•ç«¯ç‚¹
    endpoint: http://localhost:9515
```

## äº”ã€è¡¥å……åçš„åŠŸèƒ½éªŒè¯

### 5.1 JSæ‰©å±•åŠ è½½åŠŸèƒ½éªŒè¯

#### 5.1.1 å•å…ƒæµ‹è¯•

```java
@Test
public void testLoadJSExtension() throws Exception {
    // å‡†å¤‡æµ‹è¯•æ•°æ®
    String testKeyPath = "test/keys/chrome/test-key.js";
    String testTouchPath = "test/touch/chrome/test-touch.js";
    
    // ç¡®ä¿æµ‹è¯•æ–‡ä»¶å­˜åœ¨
    Files.createDirectories(Paths.get("test/keys/chrome"));
    Files.createDirectories(Paths.get("test/touch/chrome"));
    Files.write(Paths.get(testKeyPath), "console.log('test key extension');".getBytes());
    Files.write(Paths.get(testTouchPath), "console.log('test touch extension');".getBytes());
    
    // æ‰§è¡Œæµ‹è¯•
    pluginManageImpl.loadJSExtension(testKeyPath, testTouchPath);
    
    // éªŒè¯æ–‡ä»¶æ˜¯å¦è¢«æ­£ç¡®å¤åˆ¶
    Path keyTarget = Paths.get(extensionConfig.getKeyExtensionPath());
    Path touchTarget = Paths.get(extensionConfig.getTouchExtensionPath());
    
    assertTrue(Files.exists(keyTarget));
    assertTrue(Files.exists(touchTarget));
    assertEquals("console.log('test key extension');", 
                new String(Files.readAllBytes(keyTarget)));
    assertEquals("console.log('test touch extension');", 
                new String(Files.readAllBytes(touchTarget)));
}
```

#### 5.1.2 é›†æˆæµ‹è¯•

```java
@Test
public void testLoadPluginWithJSExtension() {
    // å‡†å¤‡è¯·æ±‚å‚æ•°
    LoadExtensionRequest request = new LoadExtensionRequest();
    request.setName("TestPlugin");
    request.setVersion("1.0.0");
    request.setType("ChromeExtension");
    request.setKeyPath("test/keys/chrome/test-key.js");
    request.setTouchPath("test/touch/chrome/test-touch.js");
    request.setJarPath("test/sdk/test-sdk.jar");
    
    // æ‰§è¡Œæµ‹è¯•
    boolean result = pluginManageImpl.loadExtension(request);
    
    // éªŒè¯ç»“æœ
    assertTrue(result);
    assertEquals("COMPLETE", pluginManageImpl.getPluginStatus());
    
    // éªŒè¯JARæ–‡ä»¶è¢«å¤åˆ¶åˆ°æ­£ç¡®ä½ç½®
    JarFile jarFile = new JarFile(extensionConfig.getJarDirPath() + "/test-sdk.jar");
    assertNotNull(jarFile);
    jarFile.close();
}
```

### 5.2 BrowserCheckTaskåŠŸèƒ½éªŒè¯

#### 5.2.1 å•å…ƒæµ‹è¯•

```java
@Test
public void testCheckBrowsers() {
    // å‡†å¤‡æµ‹è¯•æ•°æ®
    Set<String> testUsers = Set.of("user1", "user2", "user3");
    
    // æ¨¡æ‹ŸChromeSet.getAllUser()è¿”å›æµ‹è¯•ç”¨æˆ·
    Set<String> allUsers = chromeSet.getAllUser();
    testUsers.forEach(user -> {
        UserChrome chrome = mock(UserChrome.class);
        when(chromeSet.get(user)).thenReturn(chrome);
        when(chrome.getChromeDriver()).thenReturn(chromeDriver);
    });
    
    // æ¨¡æ‹Ÿå¥åº·æ£€æŸ¥ç»“æœï¼ˆéƒ¨åˆ†å¤±è´¥ï¼‰
    Type.HealthCheckResult mockResult = mock(Type.HealthCheckResult.class);
    when(mockResult.isSuccess()).thenReturn(false);
    when(mockResult.getErrContexts()).thenReturn(Set.of("errContext1"));
    when(mockResult.getErrContexts().contains(anyString())).thenAnswer(invocation -> {
        String contextId = invocation.getArgument(0);
        return "errContext1".equals(contextId);
    });
    
    // æ‰§è¡Œæµ‹è¯•
    browserCheckTask.checkBrowsers();
    
    // éªŒè¯ç»“æœ
    verify(chromeSet, times(1)).delete("user1");  // å‡è®¾user1å¯¹åº”errContext1
    verify(chromeSet, never()).delete("user2");   // å‡è®¾user2ä¸å¯¹åº”ä»»ä½•é”™è¯¯ä¸Šä¸‹æ–‡
}
```

#### 5.2.2 é›†æˆæµ‹è¯•

```java
@Test
public void testBrowserCheckTaskIntegration() throws InterruptedException {
    // åˆ›å»ºæµ‹è¯•ç”¨æˆ·å®ä¾‹
    UserChrome chrome1 = createUserChrome("user1");
    chrome1.getChromeDriver().setProxyContextId("errContext1");
    
    UserChrome chrome2 = createUserChrome("user2");
    chrome2.getChromeDriver().setProxyContextId("normalContext");
    
    // å¯åŠ¨å¥åº·æ£€æŸ¥ä»»åŠ¡ï¼ˆå‡å°‘é—´éš”ä»¥ä¾¿å¿«é€Ÿæµ‹è¯•ï¼‰
    browserCheckTask.setPeriod(5000);  // 5ç§’æ£€æŸ¥ä¸€æ¬¡
    browserCheckTask.init();
    
    // æ¨¡æ‹Ÿå¥åº·æ£€æŸ¥å¤±è´¥
    when(healthClient.healthCheck()).thenReturn(createFailedHealthCheckResult());
    
    // ç­‰å¾…æ‰§è¡Œ
    Thread.sleep(10000);
    
    // éªŒè¯ç»“æœ
    verify(chromeSet, atLeastOnce()).delete("user1");
    verify(chromeSet, never()).delete("user2");
}
```

## å…­ã€é£é™©ä¸å½±å“åˆ†æ

### 6.1 æŠ€æœ¯é£é™©

#### 6.1.1 JSæ‰©å±•åŠ è½½

| é£é™©é¡¹ | å½±å“ç­‰çº§ | ç¼“è§£æªæ–½ |
|-------|---------|---------|
| æ–‡ä»¶æƒé™é—®é¢˜ | ä¸­ | æ·»åŠ æ–‡ä»¶æƒé™æ£€æŸ¥ |
| è·¯å¾„éå†æ”»å‡» | é«˜ | éªŒè¯æ–‡ä»¶è·¯å¾„åˆæ³•æ€§ |
| æ‰©å±•æ–‡ä»¶æŸå | ä¸­ | æ·»åŠ æ–‡ä»¶å®Œæ•´æ€§éªŒè¯ |
| å¹¶å‘åŠ è½½å†²çª | ä½ | ä½¿ç”¨æ–‡ä»¶é”æœºåˆ¶ |

#### 6.1.2 BrowserCheckTask

| é£é™©é¡¹ | å½±å“ç­‰çº§ | ç¼“è§£æªæ–½ |
|-------|---------|---------|
| å¥åº·æ£€æŸ¥è¯¯åˆ¤ | ä¸­ | å¢åŠ é‡è¯•æœºåˆ¶å’Œç¡®è®¤é€»è¾‘ |
| æ‰¹é‡æ¸…ç†æ“ä½œ | ä¸­ | æ·»åŠ ç¡®è®¤æ­¥éª¤å’Œé™æµæœºåˆ¶ |
| èµ„æºå ç”¨ | ä½ | é™åˆ¶æ£€æŸ¥é¢‘ç‡å’Œå¹¶å‘æ•° |

### 6.2 ä¸šåŠ¡å½±å“

| å½±å“é¡¹ | æ–°å¢åŠŸèƒ½å‰ | æ–°å¢åŠŸèƒ½å | æ”¹è¿› |
|-------|-----------|-----------|------|
| é”®ç›˜æ‰©å±•æ”¯æŒ | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ | æ¢å¤å®Œæ•´åŠŸèƒ½ |
| è§¦æ§æ‰©å±•æ”¯æŒ | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ | æ¢å¤å®Œæ•´åŠŸèƒ½ |
| è‡ªåŠ¨æ•…éšœæ¢å¤ | âŒ ä¸å­˜åœ¨ | âœ… æ”¯æŒ | æé«˜ç³»ç»Ÿç¨³å®šæ€§ |
| èµ„æºç®¡ç† | æ‰‹åŠ¨æ¸…ç† | è‡ªåŠ¨æ¸…ç† | å‡å°‘è¿ç»´æˆæœ¬ |

## ä¸ƒã€å®æ–½è®¡åˆ’

### 7.1 å¼€å‘é˜¶æ®µ

| é˜¶æ®µ | ä»»åŠ¡ | å·¥ä½œé‡ | ä¼˜å…ˆçº§ |
|-----|------|--------|-------|
| è®¾è®¡ | æ‰©å±•é…ç½®è®¾è®¡ | 1äººå¤© | é«˜ |
| å¼€å‘ | JSæ‰©å±•åŠ è½½åŠŸèƒ½å¼€å‘ | 3äººå¤© | é«˜ |
| å¼€å‘ | BrowserCheckTaskå¼€å‘ | 2äººå¤© | é«˜ |
| æµ‹è¯• | å•å…ƒæµ‹è¯•ç¼–å†™ | 2äººå¤© | ä¸­ |
| æµ‹è¯• | é›†æˆæµ‹è¯•ç¼–å†™ | 2äººå¤© | ä¸­ |
| æ–‡æ¡£ | åŠŸèƒ½è¡¥å……æ–‡æ¡£ | 1äººå¤© | ä¸­ |

### 7.2 æµ‹è¯•é˜¶æ®µ

| æµ‹è¯•ç±»å‹ | è¦†ç›–èŒƒå›´ | å·¥å…· | é¢„æœŸç»“æœ |
|--------|---------|------|---------|
| å•å…ƒæµ‹è¯• | æ ¸å¿ƒæ–¹æ³•é€»è¾‘ | JUnit5 | é€šè¿‡ç‡100% |
| é›†æˆæµ‹è¯• | å®Œæ•´ä¸šåŠ¡æµç¨‹ | TestContainers | åŠŸèƒ½æ­£å¸¸ |
| æ€§èƒ½æµ‹è¯• | å¹¶å‘æ‰©å±•åŠ è½½ | JMeter | æ— æ€§èƒ½é€€åŒ– |
| å‹åŠ›æµ‹è¯• | é•¿æ—¶é—´è¿è¡Œ | ä¸€èˆ¬ | ç¨³å®šè¿è¡Œ |

### 7.3 å‘å¸ƒé˜¶æ®µ

| æ­¥éª¤ | æ“ä½œ | æ³¨æ„äº‹é¡¹ |
|-----|------|---------|
| 1. å¤‡ä»½ | å¤‡ä»½é‡å†™ä»£ç  | ç¡®ä¿å¯ä»¥å›æ»š |
| 2. è¡¥å…… | æ·»åŠ JSæ‰©å±•åŠŸèƒ½ | åœæœºæ—¶é—´çŸ­ |
| 3. è¡¥å…… | æ·»åŠ BrowserCheckTask | çƒ­éƒ¨ç½² |
| 4. éªŒè¯ | åŠŸèƒ½éªŒè¯æµ‹è¯• | æ£€æŸ¥æ–°åŠŸèƒ½ |
| 5. å‘å¸ƒ | ç”Ÿäº§ç¯å¢ƒå‘å¸ƒ | åˆ†æ‰¹ä¸Šçº¿ |

## å…«ã€é¢„æœŸæ•ˆæœ

### 8.1 åŠŸèƒ½å®Œæ•´æ€§

- âœ… **100%æ¢å¤JSæ‰©å±•åŠŸèƒ½**ï¼šæ”¯æŒæŒ‰é”®æ‰©å±•å’Œè§¦æ§æ‰©å±•
- âœ… **100%æ¢å¤BrowserCheckTaskåŠŸèƒ½**ï¼šè‡ªåŠ¨æ•…éšœæ¢å¤
- âœ… **100%å…¼å®¹å­˜é‡ä»£ç **ï¼šä¿æŒAPIæ¥å£ä¸å˜

### 8.2 ç³»ç»Ÿç¨³å®šæ€§

- ğŸ”’ **è‡ªåŠ¨æ•…éšœæ¢å¤**ï¼šå¼‚å¸¸æµè§ˆå™¨å®ä¾‹è‡ªåŠ¨æ¸…ç†
- ğŸ”’ **èµ„æºä¼˜åŒ–**ï¼šå®šæœŸæ¸…ç†ï¼Œé¿å…èµ„æºæ³„æ¼
- ğŸ”’ **å¥åº·ç›‘æ§**ï¼šå¯æ£€æµ‹ChromeæœåŠ¡å¼‚å¸¸çŠ¶æ€

### 8.3 ä¸šåŠ¡ä»·å€¼

- ğŸ”„ **å®Œæ•´åŠŸèƒ½é“¾è·¯**ï¼šæ‰©å±•é…ç½®-ä¸‹è½½-åŠ è½½-éªŒè¯-ä½¿ç”¨
- ğŸ”„ **æ— ç¼åˆ‡æ¢**ï¼šå­˜é‡ä»£ç å¯æ— ç¼åˆ‡æ¢åˆ°é‡å†™ä»£ç 
- ğŸ”„ **è¿ç»´å‹å¥½**ï¼šè‡ªåŠ¨åŒ–å‡å°‘äººå·¥å¹²é¢„

## ä¹ã€ç»“è®º

é€šè¿‡åœ¨é‡å†™ä»£ç ä¸­è¡¥å……JSæ‰©å±•åŠ è½½åŠŸèƒ½å’ŒBrowserCheckTaskåŠŸèƒ½ï¼Œå¯ä»¥å®ç°ä¸å­˜é‡ä»£ç 100%åŠŸèƒ½å¯¹é½ï¼ŒåŒæ—¶ä¿æŒé‡å†™ä»£ç æ¶æ„çš„ä¼˜åŠ¿ã€‚è¡¥å……åçš„ç³»ç»Ÿå°†å…·å¤‡ï¼š

1. **å®Œæ•´çš„åŠŸèƒ½æ”¯æŒ**ï¼šåŒ…æ‹¬æ‰€æœ‰JSæ‰©å±•ç±»å‹å’Œè‡ªåŠ¨å¥åº·æ£€æŸ¥
2. **å¢å¼ºçš„ç¨³å®šæ€§**ï¼šè‡ªåŠ¨æ•…éšœæ¢å¤å’Œèµ„æºç®¡ç†
3. **ä¼˜ç§€çš„å¯ç»´æŠ¤æ€§**ï¼šåŸºäºç°ä»£Spring Bootæ¶æ„

å»ºè®®æŒ‰è®¡åˆ’å®æ–½è¡¥å……ï¼Œå¹¶åœ¨å……åˆ†æµ‹è¯•åä¸Šçº¿ï¼Œç¡®ä¿åŠŸèƒ½ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒã€‚