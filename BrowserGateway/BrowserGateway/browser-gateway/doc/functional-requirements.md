# BrowserGateway 功能需求文档

## 文档信息

| 项目 | BrowserGateway |
|------|----------------|
| 文档类型 | 功能需求文档 |
| 版本 | 1.0 |
| 日期 | 2026-02-13 |
| 状态 | 初稿 |

---

## 1. 文档概述

### 1.1 编写目的
本文档详细描述BrowserGateway系统的功能需求，作为外网重构的功能输入和验收依据。该文档基于API手册、系统代码分析和业务理解整理而成。

### 1.2 适用范围
本文档适用于BrowserGateway系统的重构开发、测试和验收工作。

### 1.3 术语定义

| 术语 | 定义 |
|------|------|
| 浏览器实例 | 为用户创建的远程浏览器容器 |
| 会话 | 用户与浏览器实例的连接会话 |
| 控制流 | 用于传递控制命令的数据通道 |
| 媒体流 | 用于传输音视频数据的数据通道 |
| 扩展插件 | 扩展浏览器功能的插件程序 |

---

## 2. 功能概述

### 2.1 系统定位
BrowserGateway是一个云手机浏览器网关服务，为用户提供远程浏览器访问和控制能力。用户可以通过WebSocket和TCP协议与浏览器实例交互，实现屏幕传输、远程控制、媒体播放等功能。

### 2.2 核心价值
1. **安全性**：用户数据完全隔离，不存储在本地
2. **性能**：优化的媒体传输和控制响应
3. **可扩展性**：支持动态扩展和负载均衡
4. **易用性**：简洁的API和良好的用户体验

### 2.3 使用场景
- 移动办公：在移动设备上使用桌面浏览器
- 安全浏览：隔离访问敏感网站
- 浏览器测试：测试不同浏览器环境
- 媒体播放：远程播放视频和音频

---

## 3. 功能需求详细描述

### 3.1 浏览器管理功能

#### FR-001: 创建浏览器实例
**优先级**：高

**功能描述**：
为指定用户创建一个新的浏览器实例，包括配置浏览器参数、启动浏览器进程、加载扩展插件等。

**输入参数**：
```json
{
  "factory": "string",           // 设备厂商
  "dev_type": "string",          // 设备型号
  "ext_type": "string",          // 扩展类型
  "plat_type": number,           // 平台类型: 0-Android, 1-iOS
  "lcd_width": number,           // 屏幕宽度
  "lcd_height": number,          // 屏幕高度
  "app_type": number,            // 应用类型
  "appid": number,               // 应用ID
  "imsi": "string",              // 用户设备IMSI号，必填
  "imei": "string",              // 用户设备IMEI号，必填
  "device_type": number,         // 设备类型
  "client_language": "string",   // 客户端语言: "en", "zh"
  "play_mode": number,           // 播放模式
  "innerMediaEndpoint": "string" // 内部媒体端点
}
```

**输出结果**：
```json
{
  "code": 200,
  "message": "success",
  "data": "success"
}
```

**业务规则**：
1. 每个用户同一时间只能有一个活跃的浏览器实例
2. 浏览器实例必须启动成功后才返回成功
3. 扩展插件加载失败需要回退，不影响浏览器启动

**异常处理**：
- 浏览器启动失败：返回错误码和详细错误信息
- 参数校验失败：返回400错误
- 用户已存在实例：先关闭旧实例再创建新实例

**验收标准**：
- 能够成功创建浏览器实例
- 浏览器配置参数正确应用
- 扩展插件正确加载

---

#### FR-002: 预开浏览器
**优先级**：中

**功能描述**：
预先创建浏览器实例但不启动，用于提高用户首次连接的响应速度。

**业务规则**：
1. 预开的浏览器实例在用户连接前不占用过多资源
2. 预开实例在一定时间后自动清理（可配置）
3. 预开失败不影响正常创建流程

**验收标准**：
- 预开功能正常工作
- 用户连接时响应速度明显提升
- 资源占用可控

---

#### FR-003: 删除用户数据
**优先级**：高

**功能描述**：
删除指定用户的浏览器实例和用户数据，如果用户存在浏览器实例会先关闭再删除。

**输入参数**：
```json
{
  "imei": "string",
  "imsi": "string"
}
```

**输出结果**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "imei": "string",
    "imsi": "string"
  }
}
```

**业务规则**：
1. 删除前必须先关闭浏览器实例
2. 删除操作需要清理所有相关数据（缓存、Cookie等）
3. 删除操作需要记录日志

**验收标准**：
- 删除操作成功执行
- 所有相关数据被清理
- 占用的资源被释放

---

### 3.2 扩展管理功能

#### FR-004: 加载扩展
**优先级**：高

**功能描述**：
加载或更新浏览器扩展插件，需要删除所有现有浏览器实例并重新加载。

**输入参数**：
```json
{
  "name": "string",              // 插件名称，必填
  "version": "string",           // 插件版本，必填
  "bucketName": "string",        // S3存储桶名称，必填
  "extensionFilePath": "string", // 扩展文件路径，必填
  "type": "string",              // 插件类型，可选: "ChromeExtend"
  "packageName": "string"        // 包名，可选
}
```

**输出结果**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "bucketName": "string",
    "extensionFilePath": "string"
  }
}
```

**业务规则**：
1. 加载新扩展前必须关闭所有现有浏览器实例
2. 扩展文件从S3存储下载并验证
3. 支持失败重试机制（最多3次）
4. 加载失败不影响系统其他功能

**验收标准**：
- 扩展正确下载和安装
- 旧扩展被正确卸载
- 新扩展功能正常工作

---

#### FR-005: 获取插件信息
**优先级**：中

**功能描述**：
获取当前激活的浏览器扩展插件的详细信息。

**输出结果**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "name": "string",            // 插件名称
    "version": "string",         // 插件版本
    "type": "string",            // 插件类型
    "status": "string",          // 插件状态: "ACTIVE", "INACTIVE", "LOADING"
    "bucketName": "string",      // 存储桶名称
    "packageName": "string",     // 包名
    "loadTime": "string"         // 加载时间
  }
}
```

**验收标准**：
- 能够正确获取插件信息
- 插件状态准确反映当前状态

---

### 3.3 媒体流传输功能

#### FR-006: WebSocket媒体流传输
**优先级**：高

**功能描述**：
通过WebSocket协议传输音视频媒体流，支持屏幕共享和远程控制。

**技术要求**：
1. WebSocket URL：`ws://{server}:30002/browser/websocket/{imeiAndImsi}`
2. 支持两种编解码模式：WebCodecs模式和FFmpeg模式
3. 客户端连接后必须发送初始化参数：
```json
{
  "width": 1920,              // 视频宽度，默认: 1920
  "height": 1080,             // 视频高度，默认: 1080
  "frameRate": 30,            // 帧率 FPS，默认: 30
  "sampleRate": 44100,        // 采样率 Hz，默认: 44100
  "channels": 2,              // 音频通道数，默认: 2
  "bitRate": 128,             // 音频比特率 kbps，默认: 128
  "gopSize": 29,              // GOP 大小，默认: 29
  "dropFrameMulti": 0.0,      // 丢帧倍数，0-1.0，默认: 0.0
  "codecType": "H264"         // 视频编码格式: H264/H265，默认: H264
}
```

4. 媒体流数据格式：
```
[4字节: 帧类型][4字节: 时间戳][4字节: 数据长度][N字节: 数据]
```

**业务规则**：
1. 视频帧类型：1-I帧, 2-P帧, 3-Audio帧
2. 支持实时参数调整
3. 自动处理网络波动和丢帧

**性能要求**：
- 延迟 < 100ms
- 支持30fps以上流畅播放
- 自适应网络质量

**验收标准**：
- 媒体流传输流畅无卡顿
- 延迟在可接受范围内
- 支持实时参数调整

---

#### FR-007: TCP媒体流传输
**优先级**：中

**功能描述**：
通过TCP协议传输媒体流，使用TLS加密保证安全性。

**技术要求**：
1. 使用TLS加密的TCP长连接
2. 心跳超时：可配置（默认360秒）
3. 支持多种视频帧类型：
    - Type: 1-I帧, 2-P帧, 3-B帧
4. 支持多种音频格式：
    - Codec: 1-AAC, 2-OPUS

**验收标准**：
- TCP连接稳定
- 媒体流正确传输
- 加密安全可靠

---

### 3.4 控制流功能

#### FR-008: WebSocket控制流
**优先级**：高

**功能描述**：
通过WebSocket协议传输控制命令，实现远程控制浏览器。

**技术要求**：
1. WebSocket URL：`ws://{server}:30005/control/websocket/{imeiAndImsi}`
2. 作为Muen SDK与浏览器扩展之间的代理
3. 消息格式：JSON
```json
{
  "type": "string",      // 消息类型
  "payload": object      // 消息负载
}
```

**支持的控制命令**：
- 屏幕点击事件
- 键盘输入事件
- 鼠标事件
- 拖拽事件
- 文本输入事件
- 剪贴板操作

**验收标准**：
- 控制命令准确响应
- 延迟低（< 50ms）
- 支持所有控制类型

---

#### FR-009: TCP控制流
**优先级**：高

**功能描述**：
通过TCP协议传输控制命令，使用TLS加密和TLV协议格式。

**技术要求**：
1. 消息采用TLV（Type-Length-Value）编码格式
2. 基本消息类型：
    - 1: LOGIN（登录请求）
    - 2: HEARTBEATS（心跳包）
    - 3: KEY_EVENT（按键事件）
    - 4: TOUCH_EVENT（触摸事件）
    - 5: MOUSE_EVENT（鼠标事件）
    - 6: DRAG_EVENT（拖拽事件）
    - 7: TEXT_INPUT（文本输入）
    - 8: CLIPBOARD（剪贴板操作）
    - 255: LOGOUT（登出）

3. 心跳保活机制

**验收标准**：
- 控制命令准确执行
- 连接稳定可靠
- 心跳保活正常

---

### 3.5 会话管理功能

#### FR-010: 用户会话创建
**优先级**：高

**功能描述**：
为用户创建新的会话，管理用户的连接状态和权限。

**业务规则**：
1. 每个用户维护一个活跃会话
2. 会话包含用户信息和绑定关系
3. 自动清理过期会话

**验收标准**：
- 会话成功创建
- 会话状态正确维护
- 过期会话正确清理

---

#### FR-011: 会话心跳更新
**优先级**：高

**功能描述**：
定期更新用户会话的心跳时间，保持会话活跃状态。

**业务规则**：
1. 心跳超时时间可配置
2. 超时未更新的会话自动标记为过期
3. 超时会话触发清理流程

**验收标准**：
- 心跳正确更新
- 超时准确检测
- 过期会话及时清理

---

#### FR-012: 会话关闭和清理
**优先级**：高

**功能描述**：
关闭用户会话并清理相关资源，包括浏览器实例、连接通道、缓存数据等。

**业务规则**：
1. 关闭前需要保存必要的用户数据
2. 释放所有占用的资源
3. 记录会话结束日志

**验收标准**：
- 资源正确释放
- 数据妥善处理
- 日志完整记录

---

### 3.6 健康检查功能

#### FR-013: 浏览器健康检查
**优先级**：高

**功能描述**：
定期检查所有浏览器实例的健康状态，处理异常情况。

**业务规则**：
1. 检查周期：30分钟（可配置）
2. 检查项：运行状态、响应时间、资源占用
3. 异常实例自动关闭和重建

**验收标准**：
- 异常实例准确检测
- 自动恢复机制正常
- 检查资源消耗合理

---

#### FR-014: 系统资源检查
**优先级**：高

**功能描述**：
监控系统资源使用情况，根据阈值触发告警。

**监控指标**：
- CPU使用率
- 内存使用率
- 磁盘使用率
- 网络流量

**告警阈值**：
- CPU告警触发阈值：90%，恢复阈值：80%
- 内存告警触发阈值：90%，恢复阈值：80%

**验收标准**：
- 资源监控准确
- 告警及时触发
- 告警信息准确

---

#### FR-015: 连接状态监控
**优先级**：中

**功能描述**：
监控所有TCP和WebSocket连接的状态，及时清理异常连接。

**业务规则**：
1. 定期检查连接活跃度
2. 心跳超时自动断开连接
3. 记录连接异常事件

**验收标准**：
- 异常连接及时发现
- 连接正确清理
- 监控数据准确

---

### 3.7 统计和上报功能

#### FR-016: 媒体流量统计
**优先级**：中

**功能描述**：
统计和上报媒体流量数据，用于分析和监控。

**上报数据**：
```json
{
  "sessionId": "string",
  "dataSize": number,
  "startTime": string,
  "endTime": string,
  "tcpUniqueId": "string"
}
```

**业务规则**：
1. 定期上报统计数据
2. 上报失败自动重试
3. 数据格式符合规范

**验收标准**：
- 统计数据准确
- 上报及时可靠
- 失败重试有效

---

#### FR-017: 控制流量统计
**优先级**：中

**功能描述**：
统计和上报控制流量数据。

**业务规则**：
1. 统计控制命令的数量和大小
2. 按会话维度汇总
3. 定期上报

**验收标准**：
- 统计准确
- 汇总正确
- 上报可靠

---

#### FR-018: 会话信息上报
**优先级**：中

**功能描述**：
上报用户会话的开始和结束信息。

**上报数据**：
```json
{
  "sessionId": "string",
  "appType": number,
  "startTime": string,
  "endTime": string,
  "tcpUniqueId": "string"
}
```

**验收标准**：
- 会话信息完整
- 时间戳准确
- 上报及时

---

#### FR-019: 服务信息上报
**优先级**：中

**功能描述**：
向服务注册中心上报服务端点信息和容量信息。

**上报内容**：
- 服务端点（control, media, tls endpoints）
- 服务实例信息
- 服务容量信息

**验收标准**：
- 服务信息准确
- 上报成功
- 失败重试

---

### 3.8 定时任务功能

#### FR-020: 浏览器检查任务
**优先级**：高

**功能描述**：
定期检查浏览器实例状态，清理异常实例。

**任务配置**：
- 周期：30分钟（可配置）
- 检查项：运行状态、实例响应、资源占用

**验收标准**：
- 任务按时执行
- 异常检测准确
- 实例清理正确

---

#### FR-021: 浏览器关闭任务
**优先级**：高

**功能描述**：
关闭长时间无心跳的浏览器实例，释放系统资源。

**任务配置**：
- 周期：10分钟（可配置）
- TTL：100小时（可配置）

**验收标准**：
- 超时实例及时关闭
- 资源正确释放

---

#### FR-022: 连接监控任务
**优先级**：中

**功能描述**：
监控TCP连接和WebSocket连接的状态。

**任务配置**：
- 周期：10分钟（可配置）
- 监控对象：控制流、媒体流

**验收标准**：
- 连接状态监控准确
- 异常连接处理及时

---

#### FR-023: 服务状态刷新任务
**优先级**：低

**功能描述**：
定期刷新和更新服务状态信息。

**验收标准**：
- 服务状态及时更新
- 实例信息同步正确

---

### 3.9 事件处理功能

#### FR-024: 业务事件上报
**优先级**：中

**功能描述**：
上报各种业务事件，用于追踪和分析。

**事件类型**：
- USER_LOGIN: 用户登录
- USER_LOGOUT: 用户登出
- BROWSER_CREATE: 浏览器创建
- BROWSER_CLOSE: 浏览器关闭
- ERROR: 错误事件
- ALARM: 告警事件

**验收标准**：
- 事件准确上报
- 事件信息完整
- 上报失败有重试

---

#### FR-025: 告警事件处理
**优先级**：高

**功能描述**：
处理和发送告警事件，及时通知运维人员。

**告警级别**：
- CRITICAL: 严重
- MAJOR: 重要
- MINOR: 次要

**告警渠道**：
- 邮件
- 短信
- 系统通知

**验收标准**：
- 告警准确触发
- 告警信息详细
- 通知渠道畅通

---

## 4. 非功能性需求

### 4.1 性能需求

#### NFR-001: 响应时间
- API响应时间：95%的请求在200ms内响应
- 控制命令延迟：< 50ms
- 媒体流传输延迟：< 100ms

#### NFR-002: 吞吐量
- 支持并发用户数：1000+
- 每秒处理请求数：500+
- 媒体流带宽：每路20Mbps

#### NFR-003: 资源占用
- 单浏览器实例内存：< 500MB
- 单浏览器实例CPU：< 10%
- 系统内存使用率：< 80%

### 4.2 可靠性需求

#### NFR-004: 可用性
- 系统可用性：99.9%以上
- 故障恢复时间：< 5分钟
- 数据备份：每日自动备份

#### NFR-005: 容错性
- 支持服务自动重启
- 支持实例自动重建
- 支持故障自动恢复

### 4.3 安全性需求

#### NFR-006: 认证和授权
- 所有接口需要认证
- 基于角色的访问控制
- 敏感数据加密传输

#### NFR-007: 数据安全
- 用户数据隔离
- 传输层加密（TLS）
- 密钥安全管理

#### NFR-008: 审计日志
- 记录所有关键操作
- 日志不可篡改
- 日志保留90天

### 4.4 可维护性需求

#### NFR-009: 代码质量
- 代码覆盖率：≥ 80%
- 没有严重代码问题
- 遵循代码规范

#### NFR-010: 文档完整性
- API文档：完整准确
- 部署文档：详细清晰
- 运维手册：完整可操作

#### NFR-011: 监控和告警
- 系统监控：实时
- 告警及时：5分钟内
- 监控数据：30天

---

## 7. 集成需求

### 7.1 外部系统集成
- CSE服务注册中心
- Redis缓存服务
- S3对象存储
- 统计服务
- 告警服务
- 用户绑定服务

### 7.2 集成方式
- RESTful API
- WebSocket
- TCP协议

---

## 8. 验收标准

### 8.1 功能验收
- 所有功能需求100%实现
- 所有功能测试用例100%通过
- 用户验收测试通过

### 8.2 性能验收
- 性能测试全部通过
- 达到或超过原系统性能指标
- 压力测试验证通过

### 8.3 质量验收
- 代码质量审查通过
- 安全测试通过
- 文档审查通过

---

## 9. 附录

### 9.1 功能优先级

| 功能编号 | 功能名称 | 优先级 |
|---------|---------|--------|
| FR-001 | 创建浏览器实例 | 高 |
| FR-002 | 预开浏览器 | 中 |
| FR-003 | 删除用户数据 | 高 |
| FR-004 | 加载扩展 | 高 |
| FR-005 | 获取插件信息 | 中 |
| FR-006 | WebSocket媒体流传输 | 高 |
| FR-007 | TCP媒体流传输 | 中 |
| FR-008 | WebSocket控制流 | 高 |
| FR-009 | TCP控制流 | 高 |
| FR-010 | 用户会话创建 | 高 |
| FR-011 | 会话心跳更新 | 高 |
| FR-012 | 会话关闭和清理 | 高 |
| FR-013 | 浏览器健康检查 | 高 |
| FR-014 | 系统资源检查 | 高 |
| FR-015 | 连接状态监控 | 中 |
| FR-016 | 媒体流量统计 | 中 |
| FR-017 | 控制流量统计 | 中 |
| FR-018 | 会话信息上报 | 中 |
| FR-019 | 服务信息上报 | 中 |
| FR-020 | 浏览器检查任务 | 高 |
| FR-021 | 浏览器关闭任务 | 高 |
| FR-022 | 连接监控任务 | 中 |
| FR-023 | 服务状态刷新任务 | 低 |
| FR-024 | 业务事件上报 | 中 |
| FR-025 | 告警事件处理 | 高 |

### 9.2 修订历史

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|---------|--------|
| 1.0 | 2026-02-13 | 初始版本 | - |

---

